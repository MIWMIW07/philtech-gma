<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - PHILTECH</title>
    <style>
    /* Admin Panel with UMS Design */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    :root {
        --color-primary: #8B1538;
        --color-primary-light: rgba(139, 21, 56, 0.1);
        --color-primary-dark: #6B1028;
        --color-secondary: #DAA520;
        --color-secondary-light: rgba(218, 165, 32, 0.1);
        --color-danger: #EF4444;
        --color-success: #10B981;
        --color-warning: #F59E0B;
        --color-info: #6B7280;
        --color-white: #FFFFFF;
        --color-dark: #1F2937;
        --color-dark-variant: #374151;
        --color-light: rgba(229, 231, 235, 0.5);
        --color-background: #F9FAFB;
        
        --card-border-radius: 12px;
        --border-radius-1: 8px;
        --border-radius-2: 12px;
        --card-padding: 1.5rem;
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .dark-theme {
        --color-background: #111827;
        --color-white: #1F2937;
        --color-dark: #E5E7EB;
        --color-dark-variant: #D1D5DB;
        --color-light: rgba(255, 255, 255, 0.1);
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--color-background);
        color: var(--color-dark);
        transition: var(--transition);
        min-height: 100vh;
    }

    .admin-container {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 2rem;
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Admin Sidebar - UMS Style */
    .admin-sidebar {
        background: var(--color-white);
        padding: var(--card-padding);
        border-radius: var(--card-border-radius);
        box-shadow: var(--box-shadow);
        height: fit-content;
        position: sticky;
        top: 2rem;
        transition: var(--transition);
    }

    .admin-sidebar:hover {
        box-shadow: 0 10px 25px rgba(139, 21, 56, 0.15);
    }

    .admin-logo {
        text-align: center;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--color-light);
        margin-bottom: 1.5rem;
    }

    .admin-logo h2 {
        color: var(--color-primary);
        font-size: 1.75rem;
        margin-bottom: 0.25rem;
        font-weight: 800;
        letter-spacing: -0.025em;
    }

    .admin-logo span {
        color: var(--color-secondary);
    }

    .admin-logo p {
        font-size: 0.875rem;
        color: var(--color-info);
        font-weight: 500;
    }

    .nav-menu {
        list-style: none;
    }

    .nav-item {
        margin-bottom: 0.5rem;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: var(--border-radius-1);
        color: var(--color-info);
        text-decoration: none;
        transition: var(--transition);
        cursor: pointer;
        font-weight: 500;
        font-size: 0.95rem;
    }

    .nav-link:hover {
        background: var(--color-primary-light);
        color: var(--color-primary);
    }

    .nav-link.active {
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: var(--color-white);
    }

    .logout-btn {
        width: 100%;
        background: linear-gradient(135deg, var(--color-danger), #DC2626);
        color: var(--color-white);
        border: none;
        padding: 0.875rem;
        border-radius: var(--border-radius-1);
        cursor: pointer;
        font-weight: 600;
        margin-top: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: var(--transition);
        font-size: 0.95rem;
    }

    .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
    }

    /* Main Content */
    .admin-main {
        background: var(--color-white);
        padding: var(--card-padding);
        border-radius: var(--card-border-radius);
        box-shadow: var(--box-shadow);
        min-height: 80vh;
        transition: var(--transition);
    }

    .admin-main:hover {
        box-shadow: 0 10px 25px rgba(139, 21, 56, 0.15);
    }

    .admin-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--color-light);
    }

    .admin-header h2 {
        font-size: 1.75rem;
        color: var(--color-dark);
        margin-bottom: 0.5rem;
        font-weight: 800;
        letter-spacing: -0.025em;
    }

    .admin-header p {
        color: var(--color-info);
        font-size: 0.95rem;
    }

    .content-section {
        display: none;
    }

    .content-section.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--color-white);
        padding: var(--card-padding);
        border-radius: var(--card-border-radius);
        border: 2px solid transparent;
        box-shadow: var(--box-shadow);
        transition: var(--transition);
        text-align: center;
    }

    .stat-card:hover {
        border-color: var(--color-primary);
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(139, 21, 56, 0.15);
    }

    .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: var(--color-primary);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--color-primary);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: var(--color-info);
        font-size: 0.875rem;
        font-weight: 500;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--color-dark);
        font-weight: 600;
        font-size: 0.9rem;
    }

    .form-control {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--color-light);
        border-radius: var(--border-radius-1);
        font-size: 0.95rem;
        background: var(--color-background);
        color: var(--color-dark);
        transition: var(--transition);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-primary-light);
    }

    .form-group textarea {
        min-height: 120px;
        resize: vertical;
        font-family: inherit;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: var(--color-white);
        border: none;
        padding: 0.875rem 2rem;
        border-radius: var(--border-radius-1);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        font-size: 0.95rem;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(139, 21, 56, 0.3);
    }

    .btn-secondary {
        background: var(--color-white);
        color: var(--color-primary);
        border: 2px solid var(--color-primary);
        padding: 0.875rem 2rem;
        border-radius: var(--border-radius-1);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        font-size: 0.95rem;
    }

    .btn-secondary:hover {
        background: var(--color-primary);
        color: var(--color-white);
    }

    /* Tables */
    .table-container {
        overflow-x: auto;
        margin-top: 1rem;
        border-radius: var(--card-border-radius);
        box-shadow: var(--box-shadow);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: var(--color-white);
    }

    th, td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--color-light);
        font-size: 0.9rem;
    }

    th {
        background: var(--color-primary-light);
        color: var(--color-primary);
        font-weight: 700;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    tr:hover {
        background: var(--color-primary-light);
    }

    .action-btn {
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius-1);
        border: none;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        margin-right: 0.5rem;
        transition: var(--transition);
    }

    .btn-approve {
        background: var(--color-success);
        color: var(--color-white);
    }

    .btn-approve:hover {
        background: #0da271;
        transform: translateY(-2px);
    }

    .btn-delete {
        background: var(--color-danger);
        color: var(--color-white);
    }

    .btn-delete:hover {
        background: #dc2626;
        transform: translateY(-2px);
    }

    .btn-view {
        background: #3b82f6;
        color: var(--color-white);
    }

    .btn-view:hover {
        background: #2563eb;
        transform: translateY(-2px);
    }

    /* File Upload */
    .file-upload {
        border: 2px dashed var(--color-light);
        border-radius: var(--card-border-radius);
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        background: var(--color-background);
    }

    .file-upload:hover {
        border-color: var(--color-primary);
        background: var(--color-primary-light);
    }

    .file-upload input {
        display: none;
    }

    .preview-image {
        max-width: 100%;
        max-height: 400px;
        margin-top: 1rem;
        border-radius: var(--card-border-radius);
        box-shadow: var(--box-shadow);
    }

    /* Announcements List */
    .announcement-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .announcement-item {
        background: #fffbeb;
        border-left: 4px solid var(--color-warning);
        padding: var(--card-padding);
        border-radius: var(--border-radius-1);
        display: flex;
        justify-content: space-between;
        align-items: start;
        transition: var(--transition);
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .announcement-item:hover {
        transform: translateX(5px);
        box-shadow: var(--box-shadow);
    }

    .announcement-content h4 {
        color: var(--color-dark);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .announcement-content p {
        color: var(--color-info);
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .announcement-date {
        font-size: 0.75rem;
        color: var(--color-info);
        margin-top: 0.5rem;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: var(--color-white);
        padding: 2rem;
        border-radius: var(--card-border-radius);
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--color-light);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--color-info);
        transition: var(--transition);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .modal-close:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--color-danger);
        transform: rotate(90deg);
    }

    /* Theme Toggler for Admin */
    .theme-toggle-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1001;
    }

    .admin-theme-toggler {
        background: var(--color-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 1.6rem;
        width: 4.2rem;
        cursor: pointer;
        border-radius: var(--border-radius-1);
        transition: var(--transition);
    }

    .admin-theme-toggler:hover {
        background: rgba(139, 21, 56, 0.1);
    }

    /* Loading Spinner */
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--color-white);
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Schedule History Styles */
    .schedule-history {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .schedule-item {
        background: var(--color-white);
        border: 1px solid var(--color-light);
        border-radius: var(--border-radius-1);
        padding: 1.5rem;
        transition: var(--transition);
    }

    .schedule-item.current {
        border: 2px solid var(--color-primary);
        background: var(--color-primary-light);
    }

    .schedule-item:hover {
        box-shadow: var(--box-shadow);
        transform: translateY(-2px);
    }

    .schedule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .schedule-badge {
        padding: 0.25rem 0.75rem;
        background: var(--color-primary);
        color: var(--color-white);
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .schedule-date {
        color: var(--color-info);
        font-size: 0.875rem;
    }

    /* Student Details in Admin */
    .student-details {
        background: var(--color-background);
        padding: 1.5rem;
        border-radius: var(--border-radius-1);
        margin-bottom: 1.5rem;
    }

    .student-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .student-info-item h4 {
        color: var(--color-info);
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .student-info-item p {
        color: var(--color-dark);
        font-weight: 600;
    }

    @media (max-width: 968px) {
        .admin-container {
            grid-template-columns: 1fr;
            padding: 1rem;
            gap: 1rem;
        }

        .admin-sidebar {
            position: static;
            margin-bottom: 1rem;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .table-container {
            margin: 0 -1rem;
            width: calc(100% + 2rem);
        }
    }

    @media (max-width: 576px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .action-btn {
            display: block;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .admin-header h2 {
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 2rem;
        }
    }

    /* Student Program Badges */
    .program-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .program-BSCS {
        background: rgba(59, 130, 246, 0.1);
        color: #3B82F6;
    }

    .program-BTVTED {
        background: rgba(16, 185, 129, 0.1);
        color: #10B981;
    }

    .program-BSOA {
        background: rgba(139, 92, 246, 0.1);
        color: #8B5CF6;
    }

    /* Notification for Admin */
    .admin-notification {
        position: fixed;
        top: -100px;
        right: 1rem;
        background: var(--color-white);
        border-radius: var(--border-radius-1);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        z-index: 10000;
        transition: var(--transition);
        border-left: 4px solid;
    }

    .admin-notification.show {
        top: 1rem;
    }

    .admin-notification.success {
        border-left-color: var(--color-success);
    }

    .admin-notification.error {
        border-left-color: var(--color-danger);
    }

    .admin-notification-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .admin-notification.success .admin-notification-icon {
        background: var(--color-success);
        color: white;
    }

    .admin-notification.error .admin-notification-icon {
        background: var(--color-danger);
        color: white;
    }

    .admin-notification-message {
        color: var(--color-dark);
        font-weight: 500;
    }

    .admin-notification-close {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--color-info);
        font-size: 1.25rem;
        margin-left: auto;
    }
</style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h2>PHIL<span>TECH</span></h2>
                <p>Admin Panel</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard')">
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('announcements')">
                        <span>Announcements</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('students')">
                        <span>Students</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('grade-requests')">
                        <span>Grade Requests</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('schedule')">
                        <span>Schedule</span>
                    </a>
                </li>
            </ul>

            <button class="logout-btn" onclick="handleLogout()">
                <span>üö™</span>
                <span>Logout</span>
            </button>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard">
                <div class="admin-header">
                    <h2>Admin Dashboard</h2>
                    <p>Welcome back, Administrator</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="totalAnnouncements">0</div>
                        <div class="stat-label">Announcements</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="pendingRequests">0</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="scheduleStatus">Not Set</div>
                        <div class="stat-label">Schedule Status</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 1rem; color: var(--color-dark); font-weight: 600;">Recent Activity</h3>
                <div id="recentActivity" style="color: var(--color-info); padding: 1rem; background: var(--color-background); border-radius: var(--border-radius-1);">
                    <div class="loading-state" style="text-align: center;">
                        <div class="loading-spinner" style="border-top-color: var(--color-primary);"></div>
                        <p>Loading recent activity...</p>
                    </div>
                </div>
            </div>

            <!-- Announcements Section -->
            <div class="content-section" id="announcements">
                <div class="admin-header">
                    <h2>Manage Announcements</h2>
                    <p>Post and manage announcements for all students</p>
                </div>

                <div style="background: var(--color-background); padding: 2rem; border-radius: var(--card-border-radius); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--color-dark); font-weight: 600;">Create New Announcement</h3>
                    <div class="form-group">
                        <label>Announcement Title</label>
                        <input type="text" id="announcementTitle" class="form-control" placeholder="Enter announcement title">
                    </div>
                    <div class="form-group">
                        <label>Announcement Content</label>
                        <textarea id="announcementContent" class="form-control" placeholder="Enter announcement details"></textarea>
                    </div>
                    <button class="btn-primary" onclick="postAnnouncement()">Post Announcement</button>
                </div>

                <h3 style="margin-bottom: 1rem; color: var(--color-dark); font-weight: 600;">All Announcements</h3>
                <div class="announcement-list" id="announcementsList">
                    <div class="loading-state" style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner" style="border-top-color: var(--color-primary);"></div>
                        <p>Loading announcements...</p>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div class="content-section" id="students">
                <div class="admin-header">
                    <h2>üë• Manage Students</h2>
                    <p>View and manage registered students</p>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Program</th>
                                <th>Registration Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">
                                    <div class="loading-spinner" style="border-top-color: var(--color-primary); margin: 0 auto;"></div>
                                    <p style="color: var(--color-info); margin-top: 0.5rem;">Loading students...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Grade Requests Section -->
            <div class="content-section" id="grade-requests">
                <div class="admin-header">
                    <h2>üìù Grade Requests</h2>
                    <p>Manage student grade requests</p>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Email</th>
                                <th>Program</th>
                                <th>Request Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gradeRequestsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">
                                    <div class="loading-spinner" style="border-top-color: var(--color-primary); margin: 0 auto;"></div>
                                    <p style="color: var(--color-info); margin-top: 0.5rem;">Loading grade requests...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Schedule Section -->
            <div class="content-section" id="schedule">
                <div class="admin-header">
                    <h2>üìÖ Manage Schedules</h2>
                    <p>Upload and manage class schedules for all students</p>
                </div>

                <div style="background: var(--color-background); padding: 2rem; border-radius: var(--card-border-radius); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--color-dark); font-weight: 600;">Upload New Schedule</h3>
                    <div class="file-upload" onclick="document.getElementById('scheduleFile').click()">
                        <input type="file" id="scheduleFile" accept="image/*" onchange="previewSchedule(event)">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                        <p style="color: var(--color-info); margin-bottom: 0.5rem;">Click to upload schedule image</p>
                        <p style="color: var(--color-info); font-size: 0.875rem;">JPG, PNG (Max 5MB)</p>
                    </div>
                    <div id="schedulePreview"></div>
                    <button class="btn-primary" onclick="uploadSchedule()" style="margin-top: 1rem; display: none;" id="uploadScheduleBtn">Upload Schedule</button>
                </div>

                <h3 style="margin-bottom: 1rem; color: var(--color-dark); font-weight: 600;">Schedule History</h3>
                <div class="schedule-history" id="scheduleHistory">
                    <div class="loading-state" style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner" style="border-top-color: var(--color-primary);"></div>
                        <p>Loading schedule history...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Grade Input Modal -->
    <div class="modal" id="gradeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enter Student Grade</h3>
                <button class="modal-close" onclick="closeModal('gradeModal')">√ó</button>
            </div>
            <div>
                <div class="form-group">
                    <label>Student Name</label>
                    <input type="text" id="gradeStudentName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Student Program</label>
                    <input type="text" id="gradeStudentProgram" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Course Name</label>
                    <input type="text" id="gradeCourse" class="form-control" placeholder="e.g., Data Structures, Web Development">
                </div>
                <div class="form-group">
                    <label>Overall Grade (%)</label>
                    <input type="number" id="gradeOverall" class="form-control" min="0" max="100" placeholder="Enter overall grade">
                </div>
                <div class="form-group">
                    <label>Grade Breakdown (Optional)</label>
                    <textarea id="gradeBreakdown" class="form-control" placeholder="e.g., Quizzes: 88% | Assignments: 92% | Midterm: 90%"></textarea>
                </div>
                <button class="btn-primary" onclick="submitGrade()">Submit Grade</button>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Student Details</h3>
                <button class="modal-close" onclick="closeModal('studentModal')">√ó</button>
            </div>
            <div id="studentDetailsContent">
                <!-- Student details will be loaded here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            orderBy,
            updateDoc,
            deleteDoc,
            doc,
            serverTimestamp,
            where,
            getDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL,
            deleteObject
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase config (must match login.html)
        const firebaseConfig = {
            apiKey: "AIzaSyCeZi1JCg8Lrq7PYkE-pZ5R7CmWi3-Sf7E",
            authDomain: "miwmiw07.github.io",
            projectId: "philtech-82979",
            storageBucket: "philtech-82979.firebasestorage.app",
            messagingSenderId: "17606115990",
            appId: "1:17606115990:web:976e37211c65f9573378b7",
            measurementId: "G-NK2YTBYFYB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        onAuthStateChanged(auth, async (user) => {
            // Check if user is logged in via Firebase
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Check if user is admin
            const adminEmails = ['admin@philtech.edu.ph', 'learsi.gabriel07@gmail.com'];
            if (!adminEmails.includes(user.email)) {
                showAdminNotification('Access denied. Admin only.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            // User is authenticated admin - load admin functions
            console.log('Admin authenticated:', user.email);
            loadDashboardStats();
            loadAnnouncements();
            loadStudents();
            loadGradeRequests();
            loadScheduleHistory();
        });

        // Notification function for admin
        function showAdminNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `admin-notification ${type}`;
            notification.innerHTML = `
                <div class="admin-notification-icon">${type === 'success' ? '‚úì' : '‚úó'}</div>
                <div class="admin-notification-message">${message}</div>
                <button class="admin-notification-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Load dashboard stats
        async function loadDashboardStats() {
            try {
                const studentsSnap = await getDocs(collection(db, 'users'));
                const announcementsSnap = await getDocs(collection(db, 'announcements'));
                const requestsSnap = await getDocs(query(collection(db, 'gradeRequests'), where('status', '==', 'pending')));
                const scheduleSnap = await getDocs(collection(db, 'schedule'));

                document.getElementById('totalStudents').textContent = studentsSnap.size;
                document.getElementById('totalAnnouncements').textContent = announcementsSnap.size;
                document.getElementById('pendingRequests').textContent = requestsSnap.size;
                
                const currentSchedule = scheduleSnap.docs.find(doc => doc.data().isCurrent);
                document.getElementById('scheduleStatus').textContent = currentSchedule ? 'Active' : 'Not Set';

                // Load recent activity
                const recentActivity = document.getElementById('recentActivity');
                const activities = [];
                
                if (studentsSnap.size > 0) {
                    activities.push(`${studentsSnap.size} students registered`);
                }
                if (announcementsSnap.size > 0) {
                    activities.push(`${announcementsSnap.size} announcements posted`);
                }
                if (requestsSnap.size > 0) {
                    activities.push(`${requestsSnap.size} pending grade requests`);
                }
                if (currentSchedule) {
                    activities.push('Current schedule is active');
                }
                
                if (activities.length > 0) {
                    recentActivity.innerHTML = activities.map(activity => 
                        `<div style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚Ä¢</span>
                            <span>${activity}</span>
                        </div>`
                    ).join('');
                } else {
                    recentActivity.innerHTML = '<p>No recent activity</p>';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                showAdminNotification('Error loading dashboard statistics', 'error');
            }
        }

        // Post announcement
        window.postAnnouncement = async function() {
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;

            if (!title || !content) {
                showAdminNotification('Please fill in all fields', 'error');
                return;
            }

            try {
                await addDoc(collection(db, 'announcements'), {
                    title: title,
                    content: content,
                    createdAt: serverTimestamp(),
                    createdBy: auth.currentUser.email
                });

                showAdminNotification('Announcement posted successfully!', 'success');
                document.getElementById('announcementTitle').value = '';
                document.getElementById('announcementContent').value = '';
                loadAnnouncements();
                loadDashboardStats();
            } catch (error) {
                console.error('Error posting announcement:', error);
                showAdminNotification('Error posting announcement', 'error');
            }
        };

        // Load announcements
        async function loadAnnouncements() {
            try {
                const q = query(collection(db, 'announcements'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                const container = document.getElementById('announcementsList');
                container.innerHTML = '';

                if (querySnapshot.empty) {
                    container.innerHTML = '<p style="color: var(--color-info); text-align: center; padding: 2rem;">No announcements yet</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) || 'Just now';
                    
                    container.innerHTML += `
                        <div class="announcement-item">
                            <div class="announcement-content">
                                <h4>${data.title}</h4>
                                <p>${data.content}</p>
                                <div class="announcement-date">Posted on ${date} by ${data.createdBy}</div>
                            </div>
                            <button class="action-btn btn-delete" onclick="deleteAnnouncement('${doc.id}')">Delete</button>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error loading announcements:', error);
                showAdminNotification('Error loading announcements', 'error');
            }
        }

        // Delete announcement
        window.deleteAnnouncement = async function(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;

            try {
                await deleteDoc(doc(db, 'announcements', id));
                showAdminNotification('Announcement deleted', 'success');
                loadAnnouncements();
                loadDashboardStats();
            } catch (error) {
                console.error('Error deleting announcement:', error);
                showAdminNotification('Error deleting announcement', 'error');
            }
        };

        // Load students
        async function loadStudents() {
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                const tbody = document.getElementById('studentsTable');
                tbody.innerHTML = '';

                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-info); padding: 2rem;">No students registered yet</td></tr>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate().toLocaleDateString() || 'N/A';
                    const program = data.program || 'Not specified';
                    const programClass = program.replace(/[^a-zA-Z]/g, '');
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${data.displayName || 'N/A'}</td>
                            <td>${data.email}</td>
                            <td><span class="program-badge program-${programClass}">${program}</span></td>
                            <td>${date}</td>
                            <td><span style="background: var(--color-success); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${data.status || 'Active'}</span></td>
                            <td>
                                <button class="action-btn btn-view" onclick="viewStudentDetails('${doc.id}')">View Details</button>
                                <button class="action-btn btn-delete" onclick="deleteStudent('${doc.id}', '${data.displayName}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading students:', error);
                showAdminNotification('Error loading students', 'error');
            }
        }

        // View student details
        window.viewStudentDetails = async function(studentId) {
            try {
                const studentDoc = await getDoc(doc(db, 'users', studentId));
                if (!studentDoc.exists()) {
                    showAdminNotification('Student not found', 'error');
                    return;
                }

                const data = studentDoc.data();
                const date = data.createdAt?.toDate().toLocaleDateString() || 'N/A';
                const program = data.program || 'Not specified';
                
                document.getElementById('studentDetailsContent').innerHTML = `
                    <div class="student-details">
                        <div class="student-info-grid">
                            <div class="student-info-item">
                                <h4>Full Name</h4>
                                <p>${data.displayName || 'N/A'}</p>
                            </div>
                            <div class="student-info-item">
                                <h4>Email</h4>
                                <p>${data.email}</p>
                            </div>
                            <div class="student-info-item">
                                <h4>Student ID</h4>
                                <p>${data.studentId || 'N/A'}</p>
                            </div>
                            <div class="student-info-item">
                                <h4>Program</h4>
                                <p><span class="program-badge program-${program.replace(/[^a-zA-Z]/g, '')}">${program}</span></p>
                            </div>
                            <div class="student-info-item">
                                <h4>Registration Date</h4>
                                <p>${date}</p>
                            </div>
                            <div class="student-info-item">
                                <h4>Status</h4>
                                <p style="color: var(--color-success); font-weight: 600;">${data.status || 'Active'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--color-dark);">Recent Grade Requests</h4>
                    <div id="studentGradeRequests" style="margin-bottom: 1.5rem;">
                        <div class="loading-state" style="text-align: center;">
                            <div class="loading-spinner" style="border-top-color: var(--color-primary);"></div>
                            <p>Loading grade requests...</p>
                        </div>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: var(--color-dark);">Grades</h4>
                    <div id="studentGrades" style="margin-bottom: 1.5rem;">
                        <div class="loading-state" style="text-align: center;">
                            <div class="loading-spinner" style="border-top-color: var(--color-primary);"></div>
                            <p>Loading grades...</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn-primary" onclick="openGradeModal('${studentId}', '${data.displayName}', '${program}')">
                            Add Grade
                        </button>
                        <button class="btn-secondary" onclick="closeModal('studentModal')">
                            Close
                        </button>
                    </div>
                `;

                // Load student's grade requests
                const requestsQuery = query(
                    collection(db, 'gradeRequests'),
                    where('userId', '==', studentId),
                    orderBy('requestedAt', 'desc')
                );
                
                const requestsSnap = await getDocs(requestsQuery);
                const requestsContainer = document.getElementById('studentGradeRequests');
                
                if (requestsSnap.empty) {
                    requestsContainer.innerHTML = '<p style="color: var(--color-info); text-align: center;">No grade requests</p>';
                } else {
                    requestsContainer.innerHTML = '';
                    requestsSnap.forEach((doc) => {
                        const reqData = doc.data();
                        const reqDate = reqData.requestedAt?.toDate().toLocaleDateString() || 'N/A';
                        const statusColor = reqData.status === 'pending' ? 'var(--color-warning)' : 'var(--color-success)';
                        
                        requestsContainer.innerHTML += `
                            <div style="background: var(--color-background); padding: 1rem; border-radius: var(--border-radius-1); margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="font-weight: 600;">Requested: ${reqDate}</span>
                                    </div>
                                    <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                                        ${reqData.status}
                                    </span>
                                </div>
                            </div>
                        `;
                    });
                }

                // Load student's grades
                const gradesQuery = query(
                    collection(db, 'grades'),
                    where('userId', '==', studentId),
                    orderBy('createdAt', 'desc')
                );
                
                const gradesSnap = await getDocs(gradesQuery);
                const gradesContainer = document.getElementById('studentGrades');
                
                if (gradesSnap.empty) {
                    gradesContainer.innerHTML = '<p style="color: var(--color-info); text-align: center;">No grades yet</p>';
                } else {
                    gradesContainer.innerHTML = '';
                    gradesSnap.forEach((doc) => {
                        const gradeData = doc.data();
                        const gradeDate = gradeData.createdAt?.toDate().toLocaleDateString() || 'N/A';
                        const gradeValue = parseFloat(gradeData.grade) || 0;
                        
                        let gradeColor = 'var(--color-success)';
                        if (gradeValue < 75) gradeColor = 'var(--color-danger)';
                        else if (gradeValue < 90) gradeColor = 'var(--color-warning)';
                        
                        gradesContainer.innerHTML += `
                            <div style="background: var(--color-background); padding: 1rem; border-radius: var(--border-radius-1); margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">${gradeData.course || 'Course'}</span>
                                    <span style="font-size: 1.25rem; font-weight: 800; color: ${gradeColor};">${gradeValue}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--color-info);">
                                    <span>Submitted: ${gradeDate}</span>
                                    <span>By: ${gradeData.submittedBy || 'Admin'}</span>
                                </div>
                            </div>
                        `;
                    });
                }

                document.getElementById('studentModal').classList.add('active');
            } catch (error) {
                console.error('Error loading student details:', error);
                showAdminNotification('Error loading student details', 'error');
            }
        };

        // Delete student
        window.deleteStudent = async function(studentId, studentName) {
            if (!confirm(`Are you sure you want to delete ${studentName}? This action cannot be undone.`)) return;

            try {
                // Delete student document
                await deleteDoc(doc(db, 'users', studentId));
                
                // Also delete associated grade requests and grades
                const requestsQuery = query(collection(db, 'gradeRequests'), where('userId', '==', studentId));
                const requestsSnap = await getDocs(requestsQuery);
                requestsSnap.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });

                const gradesQuery = query(collection(db, 'grades'), where('userId', '==', studentId));
                const gradesSnap = await getDocs(gradesQuery);
                gradesSnap.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });

                showAdminNotification(`Student ${studentName} deleted successfully`, 'success');
                loadStudents();
                loadDashboardStats();
            } catch (error) {
                console.error('Error deleting student:', error);
                showAdminNotification('Error deleting student', 'error');
            }
        };

        // Load grade requests
        async function loadGradeRequests() {
            try {
                const q = query(collection(db, 'gradeRequests'), orderBy('requestedAt', 'desc'));
                const querySnapshot = await getDocs(q);
                const tbody = document.getElementById('gradeRequestsTable');
                tbody.innerHTML = '';

                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-info); padding: 2rem;">No grade requests yet</td></tr>';
                    return;
                }

                for (const docSnap of querySnapshot.docs) {
                    const data = docSnap.data();
                    const date = data.requestedAt?.toDate().toLocaleDateString() || 'Just now';
                    const statusColor = data.status === 'pending' ? 'var(--color-warning)' : 'var(--color-success)';
                    
                    // Get student program
                    let program = 'Not specified';
                    try {
                        const studentDoc = await getDoc(doc(db, 'users', data.userId));
                        if (studentDoc.exists()) {
                            program = studentDoc.data().program || 'Not specified';
                        }
                    } catch (error) {
                        console.error('Error fetching student data:', error);
                    }
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${data.studentName}</td>
                            <td>${data.studentEmail}</td>
                            <td><span class="program-badge program-${program.replace(/[^a-zA-Z]/g, '')}">${program}</span></td>
                            <td>${date}</td>
                            <td><span style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${data.status}</span></td>
                            <td>
                                ${data.status === 'pending' ? 
                                    `<button class="action-btn btn-approve" onclick="openGradeModalFromRequest('${docSnap.id}', '${data.studentName}', '${data.userId}', '${program}')">Enter Grade</button>` : 
                                    '<button class="action-btn btn-view" onclick="viewGradeDetails(\'' + docSnap.id + '\')">View Grade</button>'}
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading grade requests:', error);
                showAdminNotification('Error loading grade requests', 'error');
            }
        }

        // Open grade modal from request
        window.openGradeModalFromRequest = function(requestId, studentName, userId, program) {
            window.currentGradeRequest = { requestId, userId };
            document.getElementById('gradeStudentName').value = studentName;
            document.getElementById('gradeStudentProgram').value = program;
            document.getElementById('gradeModal').classList.add('active');
        };

        // Open grade modal from student details
        window.openGradeModal = function(userId, studentName, program) {
            window.currentGradeRequest = { userId };
            document.getElementById('gradeStudentName').value = studentName;
            document.getElementById('gradeStudentProgram').value = program;
            document.getElementById('gradeModal').classList.add('active');
        };

        // Submit grade
        window.submitGrade = async function() {
            const overall = document.getElementById('gradeOverall').value;
            const breakdown = document.getElementById('gradeBreakdown').value;
            const course = document.getElementById('gradeCourse').value;
        
            if (!overall || !course) {
                showAdminNotification('Please enter course name and overall grade', 'error');
                return;
            }
        
            if (overall < 0 || overall > 100) {
                showAdminNotification('Grade must be between 0 and 100', 'error');
                return;
            }
        
            try {
                const { requestId, userId } = window.currentGradeRequest;
        
                // If this is from a grade request, mark it as completed
                if (requestId) {
                    await updateDoc(doc(db, 'gradeRequests', requestId), {
                        status: 'completed',
                        completedAt: serverTimestamp()
                    });
                }
        
                // Add grade to grades collection
                await addDoc(collection(db, 'grades'), {
                    userId: userId,
                    course: course,
                    grade: parseFloat(overall),
                    breakdown: breakdown || 'No breakdown provided',
                    createdAt: serverTimestamp(),
                    submittedBy: auth.currentUser.email
                });
        
                showAdminNotification('Grade submitted successfully!', 'success');
                closeModal('gradeModal');
                loadGradeRequests();
                loadDashboardStats();
                
                // Reset form
                document.getElementById('gradeOverall').value = '';
                document.getElementById('gradeBreakdown').value = '';
                document.getElementById('gradeCourse').value = '';
            } catch (error) {
                console.error('Error submitting grade:', error);
                showAdminNotification('Error submitting grade: ' + error.message, 'error');
            }
        };

        // View grade details
        window.viewGradeDetails = async function(requestId) {
            try {
                const requestDoc = await getDoc(doc(db, 'gradeRequests', requestId));
                if (!requestDoc.exists()) {
                    showAdminNotification('Grade request not found', 'error');
                    return;
                }

                const requestData = requestDoc.data();
                
                // Find the grade for this request
                const gradesQuery = query(
                    collection(db, 'grades'),
                    where('userId', '==', requestData.userId),
                    orderBy('createdAt', 'desc'),
                    limit(1)
                );
                
                const gradesSnap = await getDocs(gradesQuery);
                
                let gradeDetails = '<p style="color: var(--color-info);">No grade details found for this request.</p>';
                
                if (!gradesSnap.empty) {
                    const gradeData = gradesSnap.docs[0].data();
                    const gradeValue = parseFloat(gradeData.grade) || 0;
                    const gradeDate = gradeData.createdAt?.toDate().toLocaleDateString() || 'N/A';
                    
                    gradeDetails = `
                        <div style="background: var(--color-background); padding: 1.5rem; border-radius: var(--border-radius-1);">
                            <h4 style="margin-bottom: 1rem; color: var(--color-dark);">Grade Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <h5 style="color: var(--color-info); font-size: 0.875rem; margin-bottom: 0.25rem;">Course</h5>
                                    <p style="font-weight: 600;">${gradeData.course || 'N/A'}</p>
                                </div>
                                <div>
                                    <h5 style="color: var(--color-info); font-size: 0.875rem; margin-bottom: 0.25rem;">Grade</h5>
                                    <p style="font-size: 1.5rem; font-weight: 800; color: var(--color-success);">${gradeValue}%</p>
                                </div>
                                <div>
                                    <h5 style="color: var(--color-info); font-size: 0.875rem; margin-bottom: 0.25rem;">Submitted By</h5>
                                    <p style="font-weight: 600;">${gradeData.submittedBy || 'Admin'}</p>
                                </div>
                                <div>
                                    <h5 style="color: var(--color-info); font-size: 0.875rem; margin-bottom: 0.25rem;">Date</h5>
                                    <p style="font-weight: 600;">${gradeDate}</p>
                                </div>
                            </div>
                            ${gradeData.breakdown ? `
                                <div>
                                    <h5 style="color: var(--color-info); font-size: 0.875rem; margin-bottom: 0.25rem;">Breakdown</h5>
                                    <p style="font-weight: 600;">${gradeData.breakdown}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                const modalContent = document.createElement('div');
                modalContent.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Grade Details for ${requestData.studentName}</h3>
                            <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                        </div>
                        <div>
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: var(--color-dark); margin-bottom: 0.5rem;">Request Information</h4>
                                <div style="background: var(--color-background); padding: 1rem; border-radius: var(--border-radius-1);">
                                    <p><strong>Student:</strong> ${requestData.studentName}</p>
                                    <p><strong>Email:</strong> ${requestData.studentEmail}</p>
                                    <p><strong>Request Date:</strong> ${requestData.requestedAt?.toDate().toLocaleDateString() || 'N/A'}</p>
                                    <p><strong>Status:</strong> ${requestData.status}</p>
                                </div>
                            </div>
                            ${gradeDetails}
                        </div>
                    </div>
                `;

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing grade details:', error);
                showAdminNotification('Error loading grade details', 'error');
            }
        };

        // Preview schedule
        window.previewSchedule = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                showAdminNotification('File size must be less than 5MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('schedulePreview').innerHTML = `
                    <img src="${e.target.result}" class="preview-image" alt="Schedule Preview">
                `;
                document.getElementById('uploadScheduleBtn').style.display = 'block';
            };
            reader.readAsDataURL(file);
            window.scheduleFile = file;
        };

        // Upload schedule (keeping history)
        window.uploadSchedule = async function() {
            if (!window.scheduleFile) {
                showAdminNotification('Please select a file first', 'error');
                return;
            }

            try {
                // Upload to Firebase Storage
                const timestamp = Date.now();
                const storageRef = ref(storage, `schedules/schedule-${timestamp}.jpg`);
                await uploadBytes(storageRef, window.scheduleFile);
                const downloadURL = await getDownloadURL(storageRef);

                // Mark all previous schedules as not current
                const allSchedules = await getDocs(collection(db, 'schedule'));
                const updatePromises = [];
                allSchedules.forEach((doc) => {
                    updatePromises.push(updateDoc(doc.ref, { isCurrent: false }));
                });
                await Promise.all(updatePromises);

                // Save new schedule as current
                await addDoc(collection(db, 'schedule'), {
                    imageUrl: downloadURL,
                    uploadedAt: serverTimestamp(),
                    uploadedBy: auth.currentUser.email,
                    isCurrent: true,
                    fileName: `schedule-${timestamp}.jpg`
                });

                showAdminNotification('Schedule uploaded successfully!', 'success');
                loadScheduleHistory();
                loadDashboardStats();
                
                // Clear preview
                document.getElementById('schedulePreview').innerHTML = '';
                document.getElementById('uploadScheduleBtn').style.display = 'none';
                document.getElementById('scheduleFile').value = '';
            } catch (error) {
                console.error('Error uploading schedule:', error);
                showAdminNotification('Error uploading schedule', 'error');
            }
        };

        // Load schedule history
        async function loadScheduleHistory() {
            try {
                const q = query(collection(db, 'schedule'), orderBy('uploadedAt', 'desc'));
                const querySnapshot = await getDocs(q);
                const container = document.getElementById('scheduleHistory');
                container.innerHTML = '';

                if (querySnapshot.empty) {
                    container.innerHTML = '<p style="color: var(--color-info); text-align: center; padding: 2rem;">No schedules uploaded yet</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.uploadedAt?.toDate().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) || 'Unknown date';
                    
                    container.innerHTML += `
                        <div class="schedule-item ${data.isCurrent ? 'current' : ''}">
                            <div class="schedule-header">
                                <div>
                                    <h4 style="color: var(--color-dark); margin-bottom: 0.25rem;">Schedule ${data.isCurrent ? '(Current)' : ''}</h4>
                                    <p class="schedule-date">Uploaded: ${date} by ${data.uploadedBy}</p>
                                </div>
                                ${data.isCurrent ? '<span class="schedule-badge">Current</span>' : ''}
                            </div>
                            <img src="${data.imageUrl}" 
                                 class="preview-image" 
                                 alt="Schedule ${date}"
                                 style="cursor: pointer;"
                                 onclick="openScheduleImage('${data.imageUrl}')">
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="action-btn btn-delete" onclick="deleteSchedule('${doc.id}', '${data.fileName}')">Delete</button>
                                ${!data.isCurrent ? `<button class="action-btn btn-approve" onclick="setAsCurrentSchedule('${doc.id}')">Set as Current</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error loading schedule history:', error);
                showAdminNotification('Error loading schedule history', 'error');
            }
        }

        // Open schedule image in modal
        window.openScheduleImage = function(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90%;">
                    <div class="modal-header">
                        <h3>Schedule View</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    <div style="text-align: center;">
                        <img src="${imageUrl}" style="max-width: 100%; max-height: 70vh; border-radius: var(--border-radius-1);">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // Delete schedule
        window.deleteSchedule = async function(id, fileName) {
            if (!confirm('Are you sure you want to delete this schedule? This action cannot be undone.')) return;

            try {
                // Delete from Firestore
                await deleteDoc(doc(db, 'schedule', id));
                
                // Delete from Storage
                try {
                    const fileRef = ref(storage, `schedules/${fileName}`);
                    await deleteObject(fileRef);
                } catch (storageError) {
                    console.warn('Could not delete file from storage:', storageError);
                }
                
                showAdminNotification('Schedule deleted successfully', 'success');
                loadScheduleHistory();
                loadDashboardStats();
            } catch (error) {
                console.error('Error deleting schedule:', error);
                showAdminNotification('Error deleting schedule', 'error');
            }
        };

        // Set schedule as current
        window.setAsCurrentSchedule = async function(id) {
            try {
                // Mark all schedules as not current
                const allSchedules = await getDocs(collection(db, 'schedule'));
                const updatePromises = [];
                allSchedules.forEach((doc) => {
                    updatePromises.push(updateDoc(doc.ref, { isCurrent: false }));
                });
                await Promise.all(updatePromises);

                // Mark selected schedule as current
                await updateDoc(doc(db, 'schedule', id), { isCurrent: true });
                
                showAdminNotification('Schedule set as current', 'success');
                loadScheduleHistory();
                loadDashboardStats();
            } catch (error) {
                console.error('Error setting schedule as current:', error);
                showAdminNotification('Error setting schedule as current', 'error');
            }
        };

        // Handle logout
        window.handleLogout = async function() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            try {
                await signOut(auth);
                showAdminNotification('Logged out successfully!', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            } catch (error) {
                console.error('Error logging out:', error);
                showAdminNotification('Error logging out. Please try again.', 'error');
            }
        };

        // Close modal
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        // Show section
        window.showSection = function(sectionId) {
            // Remove active from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active to clicked link
            event.target.closest('.nav-link').classList.add('active');
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
        };
    </script>
</body>
</html>